import{a as w,b as S,c as M,d as v,e as f,f as E,g as I,h as A}from"./chunk-WRD4GL6H.mjs";import{a as R}from"./chunk-WAP7QZFM.mjs";import{b as z,c as W}from"./chunk-O3GUHLG2.mjs";import{c as g}from"./chunk-HKIKYKUT.mjs";g();import{createFilter as q}from"@rollup/pluginutils";import k from"debug";g();import{URL as N}from"url";import F from"path";function U(i){let{pathname:e}=new N(i,"https://www.example.com");return F.extname(e)===".js"?"script":"link"}function P(i){let{url:e,...s}=i,t={tag:U(e),...s};return t.tag==="script"?t.attrs.src=e:(t.attrs.href=e,t.attrs.rel="stylesheet"),t}var D=class{_tagDescriptors;constructor(e,s){M(!!s||!!s.name,"[vite-plugin-cdn2]: missing resolve."),this._tagDescriptors=this.prepareSource(e,s)}get tagDescriptors(){return this._tagDescriptors}prepareSource(e,s){let t=[],l=(c,r)=>{if(typeof c=="string"&&t.push(P({url:c,injectTo:r,attrs:{}})),Array.isArray(c))for(let n of c){let{url:p,...a}=n;t.push(P({url:p,injectTo:r,attrs:a??{}}))}};for(let[c,r]of e){let n=P(s.setup({extra:r}));r.spare&&l(r.spare,n.injectTo),t.push(n)}return t}};function O(i,e){return new D(i,e)}var y=k("vite-plugin-cdn2"),b="node_modules";async function j(){try{let{parse:i}=(await import("rs-module-lexer")).default;return i}catch{let{parse:e}=await import("@xn-sakina/rml-wasm").catch(()=>{throw new Error("rs-module-lexer can't work on you current machine.")});return e}}function B(){let i={},e=(s,t,l,c)=>{let{output:r}=c({input:[{filename:t,code:s}]});if(!w(r))return!1;let{imports:n}=r[0],p=Array.from(new Set([...n.map(a=>a.n)]));for(let a of p)if(l[a])return!0;return!1};return{dependency:i,lex:null,get dependencyWithAlias(){let s=(t,l)=>t.reduce((c,r)=>({...c,[r]:l}),{});return Object.values(this.dependency).reduce((t,l)=>(l.aliases&&(t={...t,...s(l.aliases,l.name)}),{...t,[l.name]:l.name}),{})},filter:function(s,t){return e(s,t,this.dependencyWithAlias,this.lex)}}}function J(i){return{name:"vite-plugin-cdn2:presetModule",transform(e,s){if(i.filter(s)&&s.includes(b)){let t=v(e,i.dependency.dependency);return i.dependency.filter(e,s)?f(e,i.dependency):t}}}}function G(i={}){let{modules:e=[],include:s=/\.(mjs|js|ts|vue|jsx|tsx)(\?.*|)$/,exclude:t,logLevel:l="warn",resolve:c=R(),apply:r="build"}=i,n=A(e),{api:p}=T({modules:[],include:s,exclude:t}),a=p;return[{...(()=>({name:"vite-plugin-cdn2:transform",enforce:"post",apply:r,async configResolved(o){let[d,L]=S();try{if(!d)throw new Error(`vite-plugin-cdn2 can't work with nodejs ${L}.`);let x=await j();a.dependency.lex=x;let H=o.root;if(n.setDefaultWd(H),y("start scanning"),n.scanAllDependencies(),y("scanning done",n.dependencies),a.dependency.dependency=Object.fromEntries(n.dependencies),l==="warn"&&n.failedModules.forEach((m,h)=>o.logger.error(`vite-plugin-cdn2: ${h} ${m||"resolved failed.Please check it."}`)),r==="serve"){let m=o.optimizeDeps?.exclude||[];o.optimizeDeps.exclude=[...m,...n.dependencies.keys()];let h=o.optimizeDeps?.include||[];o.optimizeDeps.include=h.filter(_=>!o.optimizeDeps.exclude.includes(_))}}catch(x){o.logger.error(x)}},transform(o,d){if(a.filter(d)&&a.dependency.filter(o,d))return f(o,a.dependency)},transformIndexHtml(o){y("start transformIndexHtml");let d=O(n.dependencies,c);return y("transformIndexHtml Done",d.tagDescriptors),{html:o,tags:d.tagDescriptors}}}))(),apply:r},{...J(a),apply:r}]}function T(i={}){let e=k("vite-plugin-external"),{modules:s=[],include:t,exclude:l}=i,c=q(t,l),r=B();return{name:"vite-plugin-external",async buildStart(){try{let n=await j();r.lex=n,e("start check modules");for(let u of s)if(!u.global)throw new Error(`vite-plugin-external: missing global for module ${u.name}`);e("check done");let p=process.cwd(),a=await Promise.all(s.map(async u=>({bindings:await I(u,p),...u,aliases:E(u.name,u.aliases)})));r.dependency=a.reduce((u,o)=>({...u,[o.name]:o}),{}),e("scanning done",r.dependency)}catch(n){this.error(n)}},transform(n,p){if(c(p)){if(p.includes(b)){let a=v(n,r.dependency);return r.filter(n,p)?f(n,r):a}if(r.filter(n,p))return f(n,r)}},api:{filter:c,dependency:r}}}T.getExternalPluginAPI=i=>i.find(e=>e.name==="vite-plugin-external")?.api;var oe=G;export{G as cdn,oe as default,W as defineLink,z as defineScript,T as external};
