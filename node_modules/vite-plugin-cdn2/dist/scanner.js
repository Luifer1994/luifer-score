var te=Object.create;var N=Object.defineProperty;var oe=Object.getOwnPropertyDescriptor;var ne=Object.getOwnPropertyNames;var ie=Object.getPrototypeOf,se=Object.prototype.hasOwnProperty;var ae=(r,e)=>()=>(r&&(e=r(r=0)),e);var W=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports),ce=(r,e)=>{for(var o in e)N(r,o,{get:e[o],enumerable:!0})},_=(r,e,o,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let t of ne(e))!se.call(r,t)&&t!==o&&N(r,t,{get:()=>e[t],enumerable:!(n=oe(e,t))||n.enumerable});return r};var m=(r,e,o)=>(o=r!=null?te(ie(r)):{},_(e||!r||!r.__esModule?N(o,"default",{value:r,enumerable:!0}):o,r)),le=r=>_(N({},"__esModule",{value:!0}),r);var de,y,u=ae(()=>{de=()=>require("url").pathToFileURL(__filename).href,y=de()});var F=W((Ae,M)=>{"use strict";u();var{bind:fe,call:ue}=Function.prototype,pe=fe.bind(ue);M.exports.uncurryThis=pe;var me=Object.getPrototypeOf(Uint8Array.prototype);M.exports.TypedArrayPrototype=me;var ge=(r,e,o,n)=>{if(e in r){if(n===!0){if(r[e]===o)return}else if(!(typeof n=="function"&&Object.prototype.toString.call(n)==="[object Function]")||!n())return}Object.defineProperty(r,e,{configurable:!0,enumerable:!1,value:o,writable:!0})},R=(r,e,o={})=>{let n=Array.prototype.concat.call(Object.keys(e),Object.getOwnPropertySymbols(e));for(let t=0,i=n.length;t<i;t++)ge(r,n[t],e[n[t]],o[n[t]])};M.exports.defineProperties=R;var be=(r,e)=>R(r,{implementation:e,getPolyfill:()=>e,shim:()=>e});M.exports.makeEsShim=be});var B=W((ve,$)=>{"use strict";u();var{makeEsShim:ye}=F(),q=typeof AggregateError=="function"?AggregateError:(()=>{function r(e,o){let n=new Error(o);return Object.setPrototypeOf(n,r.prototype),delete n.constructor,Object.defineProperty(n,"errors",{value:Array.from(e)}),n}return Object.defineProperty(r,"prototype",{writable:!1}),Object.defineProperties(r.prototype,{constructor:{enumerable:!1,configurable:!0,writable:!0,value:r},message:{enumerable:!1,configurable:!0,writable:!0,value:""},name:{enumerable:!1,configurable:!0,writable:!0,value:"AggregateError"}}),Object.setPrototypeOf(r.prototype,Error.prototype),r})(),C=q;ye(C,q);$.exports=C});var De={};ce(De,{createScanner:()=>Pe,getPackageExports:()=>Y,serializationExportsFields:()=>O});module.exports=le(De);u();var j=m(require("fs/promises")),A=m(require("url")),Q=m(require("module")),H=m(require("path")),b=m(require("worker_threads"));u();var p=require("@babel/core");u();var k=m(require("path")),V=m(require("fs")),L=m(require("os"));var xe=m(require("magic-string")),U=m(B());function I(r,e){let o=k.default.dirname(r),n=k.default.join(o,e);return V.default.existsSync(n)?n:I(o,e)}function x(r){return r.length}function z(r,e){if(!r)throw new Error(e)}var S=new Function("specifier","return import(specifier)");var J=(()=>{let r=L.default.cpus()||{length:1};return Math.max(1,r.length-1)})(),v=class{maxConcurrent;queue;running;errors;constructor(e){this.maxConcurrent=e,this.queue=[],this.running=0,this.errors=[]}enqueue(e){this.queue.push(e),this.run()}async run(){for(;this.running<this.maxConcurrent&&this.queue.length;){let e=this.queue.shift();this.running++;try{await e?.()}catch(o){this.errors.push(o)}finally{this.running--,this.run()}}}async wait(){for(;this.running;)await new Promise(e=>setTimeout(e,0));if(x(this.errors))throw new U.default(this.errors,"failed")}};function G(r){return new v(r)}async function X(r){let e=await(0,p.parse)(r,{babelrc:!1,configFile:!1}),{body:o}=e.program;if(!x(o))return;let n=o[0];if(p.types.isVariableDeclaration(n)){let a=n.declarations[0].id;if(p.types.isIdentifier(a))return a.name}let t="",i="";return(0,p.traverse)(e,{ExpressionStatement:a=>{if(p.types.isCallExpression(a.node.expression)&&p.types.isFunctionExpression(a.node.expression.callee)){let s=a.node.expression.callee.params;x(s)&&s[0].type==="Identifier"&&!i&&(i=s[0].name)}},AssignmentExpression:a=>{if(t)return a.skip();let s=a.get("left");if(s.node.type==="MemberExpression"){let{start:c,end:l}=s.node.object;new RegExp(i||"global","i").test(r.slice(c,l))&&p.types.isIdentifier(s.node.property)&&(t||(t=s.node.property.name))}}}),t}var K=Q.default.createRequire(y),he=A.default.fileURLToPath(y);function Ee(r,e){let{port1:o,port2:n}=new b.default.MessageChannel,t=new b.default.Worker(he,{workerData:{workerPort:n,internalThread:!0,scannerModule:r.modules,defaultWd:e},transferList:[n],execArgv:[]}),i=0;return t.unref(),(()=>{let s=new SharedArrayBuffer(4),c=new Int32Array(s);t.postMessage({sharedBuffer:s,id:i});let l=Atomics.wait(c,0,0);if(l!=="ok"&&l!=="not-equal")throw new Error("Internal error: Atomics.wait() failed: "+l);let{message:d}=b.default.receiveMessageOnPort(o);if(d.id!==i)throw new Error(`Internal error: Expected id ${i} but got id ${d.id}`);if(d.error)throw d.error;let{bindings:h,failedModules:g}=d;return{dependencies:h,failedModules:g}})()}function O(r,e=[]){return e.filter(o=>o!==".").map(o=>H.default.posix.join(r,o))}async function Y(...r){let e;switch(x(r)){case 1:{let t=r[0];if(typeof t!="string")throw new Error("Invalid type");e=await S(A.default.pathToFileURL(t));break}case 2:{let[t,i]=r;if(typeof t!="object")throw new Error("Invalid type");let a=K.resolve(t.name,{paths:[i]});e=await S(A.default.pathToFileURL(a));break}}let o=Object.keys(e);if(o.includes("default")&&x(o)!==1){let t=o.findIndex(i=>i==="default");o.splice(t,1),o.push(...Object.keys(e.default))}return new Set(o.filter(t=>t!=="__esModule"))}async function Me(r,e,o,n){let{name:t,relativeModule:i,aliases:a,...s}=r;try{let c=K.resolve(t,{paths:[n]}),l=I(c,"package.json"),d=await j.default.readFile(l,"utf8"),h=JSON.parse(d),{version:g,name:f,unpkg:w,jsdelivr:P}=h,E=Object.create(null),D=i||P||w;if(!D)throw new Error("try resolve file failed.");if(s.global)Object.assign(E,{name:f,version:g,relativeModule:D,aliases:O(f,a),...s});else{let ee=I(l,D),re=await j.default.readFile(ee,"utf8");Object.assign(E,{name:f,version:g,code:re,relativeModule:D,aliases:O(f,a),...s})}let Z=await Y(c);e.set(f,{...E,bindings:Z})}catch(c){let l=(()=>c instanceof Error?"code"in c&&c.code==="MODULE_NOT_FOUND"?"can't find module.":c.message:c)();o.set(t,l)}}function we(){if(!b.default.workerData.internalThread)return;let{workerPort:r,scannerModule:e,defaultWd:o}=b.default.workerData,{parentPort:n}=b.default,t=new Map,i=new Map;n?.on("message",a=>{(async()=>{let{id:s,sharedBuffer:c}=a,l=new Int32Array(c);try{let d=new Map,h=G(J);for(let g of e)h.enqueue(()=>Me(g,t,i,o));await h.wait();for(let g of e){let{name:f}=g;if(t.has(f)){let{code:w,...P}=t.get(f);if(!w){d.set(f,P);continue}let E=await X(w);E?d.set(f,{...P,global:E}):i.set(f,"try resolve global name failed.")}}t.clear(),r.postMessage({bindings:d,id:s,failedModules:i})}catch(d){r.postMessage({error:d,id:s})}Atomics.add(l,0,1),Atomics.notify(l,0,1/0)})()})}b.default.workerData?.internalThread&&we();var T=class{modules;dependencies;failedModules;defaultWd;constructor(e){this.modules=e,this.dependencies=new Map,this.failedModules=new Map,this.defaultWd=process.cwd()}setDefaultWd(e){this.defaultWd=e}scanAllDependencies(){let e=Ee(this.serialization(this.modules),this.defaultWd);this.dependencies=e.dependencies,this.failedModules=e.failedModules}serialization(e){z(Array.isArray(e),"vite-plugin-cdn2: option module must be array");let o=[],n=new Set;for(let t of e){if(typeof t=="string"){if(n.has(t)||!t)continue;o.push({name:t}),n.add(t);continue}!t.name||n.has(t.name)||(o.push(t),n.add(t.name))}return{modules:o}}};function Pe(r){return new T(r)}0&&(module.exports={createScanner,getPackageExports,serializationExportsFields});
