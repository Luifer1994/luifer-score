import{a as $,b as oe,c as N}from"./chunk-HKIKYKUT.mjs";var V=$((Ae,S)=>{"use strict";N();var{bind:ne,call:ie}=Function.prototype,se=ne.bind(ie);S.exports.uncurryThis=se;var ae=Object.getPrototypeOf(Uint8Array.prototype);S.exports.TypedArrayPrototype=ae;var ce=(o,r,n,s)=>{if(r in o){if(s===!0){if(o[r]===n)return}else if(!(typeof s=="function"&&Object.prototype.toString.call(s)==="[object Function]")||!s())return}Object.defineProperty(o,r,{configurable:!0,enumerable:!1,value:n,writable:!0})},B=(o,r,n={})=>{let s=Array.prototype.concat.call(Object.keys(r),Object.getOwnPropertySymbols(r));for(let i=0,u=s.length;i<u;i++)ce(o,s[i],r[s[i]],n[s[i]])};S.exports.defineProperties=B;var le=(o,r)=>B(o,{implementation:r,getPolyfill:()=>r,shim:()=>r});S.exports.makeEsShim=le});var J=$((ve,z)=>{"use strict";N();var{makeEsShim:de}=V(),L=typeof AggregateError=="function"?AggregateError:(()=>{function o(r,n){let s=new Error(n);return Object.setPrototypeOf(s,o.prototype),delete s.constructor,Object.defineProperty(s,"errors",{value:Array.from(r)}),s}return Object.defineProperty(o,"prototype",{writable:!1}),Object.defineProperties(o.prototype,{constructor:{enumerable:!1,configurable:!0,writable:!0,value:o},message:{enumerable:!1,configurable:!0,writable:!0,value:""},name:{enumerable:!1,configurable:!0,writable:!0,value:"AggregateError"}}),Object.setPrototypeOf(o.prototype,Error.prototype),o})(),U=L;de(U,L);z.exports=U});N();import Z from"fs/promises";import q from"url";import Ee from"module";import Me from"path";import A from"worker_threads";N();import{parse as ge,transform as be,types as e,traverse as ye}from"@babel/core";N();var X=oe(J());import G from"path";import fe from"fs";import ue from"os";import pe from"process";import me from"magic-string";function _(o,r){let n=G.dirname(o),s=G.join(n,r);return fe.existsSync(s)?s:_(n,r)}function M(o){return o.length}function Re(){let[o,r]=pe.versions.node.split(".");return+o<12||+o==12&&+r<17||+o==13&&+r<13?[!1,`${o}.${r}`]:[!0,`${o}.${r}`]}function Q(o,r){if(!o)throw new Error(r)}var F=new Function("specifier","return import(specifier)");function Fe(o,r){let n=new me(o);for(let s in r){let i=new RegExp(`require\\((["'\`])\\s*${s}\\s*(\\1)\\)`,"g");n.replace(i,r[s].global)}return{code:n.toString(),map:n.generateMap()}}var H=(()=>{let o=ue.cpus()||{length:1};return Math.max(1,o.length-1)})(),R=class{maxConcurrent;queue;running;errors;constructor(r){this.maxConcurrent=r,this.queue=[],this.running=0,this.errors=[]}enqueue(r){this.queue.push(r),this.run()}async run(){for(;this.running<this.maxConcurrent&&this.queue.length;){let r=this.queue.shift();this.running++;try{await r?.()}catch(n){this.errors.push(n)}finally{this.running--,this.run()}}}async wait(){for(;this.running;)await new Promise(r=>setTimeout(r,0));if(M(this.errors))throw new X.default(this.errors,"failed")}};function K(o){return new R(o)}function xe(o){return e.isProgram(o.parent)||e.isExportDefaultDeclaration(o.parent)||e.isExportNamedDeclaration(o.parent)}function he(o){return function(){let{dependency:r,dependencyWithAlias:n}=o,s=new Map,i=new Map,u=t=>{let a=n[t.node.source.value],{global:f}=r[a];for(let c of t.node.specifiers)switch(c.type){case"ImportDefaultSpecifier":case"ImportNamespaceSpecifier":s.set(c.local.name,`${f}.${c.type}.${a}`);break;case"ImportSpecifier":c.imported.type==="Identifier"&&s.set(c.local.name,`${f}.${c.imported.name}.${a}`)}},m=t=>{let a=[],f=[],c=t.node.source,d=c?n[t.node.source.value]:"",g=c&&d?r[d].global:"",y=c&&d?r[d].bindings:new Set,I=(l,x,D)=>{if(y.size){if(l.name==="default"&&l.name!==x.name){let E=P=>e.memberExpression(e.identifier(g),e.identifier(P)),w=[...y.keys()].map(P=>e.objectProperty(e.identifier(P),E(P))),h=e.variableDeclarator(e.identifier(x.name),e.objectExpression(w));a.push(h);return}if(x.name==="default"&&l.name!==x.name){let E=e.memberExpression(e.identifier(g),e.identifier(l.name));a.push(E);return}if(l.name===x.name){if(l.name==="default"){let E=P=>e.memberExpression(e.identifier(g),e.identifier(P)),w=[...y.keys()].map(P=>e.objectProperty(e.identifier(P),E(P))),h=e.objectExpression(w);a.push(h);return}if(y.has(l.name)){let E=e.memberExpression(e.identifier(g),e.identifier(l.name)),w=e.variableDeclarator(e.identifier(l.name),E);a.push(w);return}}f.push(D)}},k=(l,x,D)=>{if(s.has(l.name)){let[E,w,h]=s.get(l.name).split("."),P=(()=>{if(w==="ImportNamespaceSpecifier"){let te=O=>e.memberExpression(e.identifier(E),e.identifier(O));return e.objectExpression([...r[h].bindings.keys()].map(O=>e.objectProperty(e.identifier(O),te(O))))}return e.memberExpression(e.identifier(E),e.identifier(w))})();x.name==="default"?a.push(P):a.push(e.variableDeclarator(e.identifier(l.name),P));return}f.push(D)};for(let l of t.node.specifiers){if(l.type==="ExportSpecifier"){let{local:x,exported:D}=l;if(D.type!=="Identifier")continue;c?I(x,D,l):k(x,D,l)}if(l.type==="ExportNamespaceSpecifier"){let x=l.exported;if(x.name==="default"){let D=h=>e.memberExpression(e.identifier(g),e.identifier(h)),E=[...y.keys()].map(h=>e.objectProperty(e.identifier(h),D(h))),w=e.objectExpression(E);a.push(w)}else{let D=h=>e.memberExpression(e.identifier(g),e.identifier(h)),E=[...y.keys()].map(h=>e.objectProperty(e.identifier(h),D(h))),w=e.variableDeclarator(e.identifier(x.name),e.objectExpression(E));a.push(w)}}}let v=a.filter(l=>l.type==="VariableDeclarator"),j=a.filter(l=>l.type!=="VariableDeclarator");if(M(j)){let l=e.exportDefaultDeclaration(j[0]);M(v)||M(f)?t.insertAfter(l):t.replaceWith(l)}if(M(v)){let l=e.variableDeclaration("var",v);if(M(f)){let x=e.exportNamedDeclaration(null,f);t.replaceWith(x),t.insertAfter(e.exportNamedDeclaration(l,[]))}else t.replaceWith(e.exportNamedDeclaration(l,[]))}},p=t=>{let a=[],f=n[t.node.source.value],{bindings:c}=r[f];if(c.forEach(d=>{let g=e.identifier(d),y=e.exportSpecifier(g,g);a.push(y)}),M(a)){let d=e.exportNamedDeclaration(null,a,e.stringLiteral(t.node.source.value));t.replaceWith(d)}},b=(t,a)=>{if(!Array.isArray(t))return;let f=c=>{if(!Array.isArray(c)){if(e.isVariableDeclarator(c.node)&&((e.isObjectPattern(c.node.id)||e.isArrayPattern(c.node.id))&&f(c.get("id")),e.isRestElement(c.node.id)&&f(c.get("id.argument")),e.isIdentifier(c.node.id))){let d=c.node.id.name;a.has(d)&&a.get(d).remove(),a.set(d,c);return}if(e.isObjectPattern(c.node))for(let d of c.get("properties"))f(d);if(e.isArrayPattern(c.node))for(let d of c.get("elements"))f(d)}};for(let c of t)f(c)};return{visitor:{ImportDeclaration:{enter:t=>{n[t.node.source.value]&&u(t)},exit:t=>{n[t.node.source.value]&&(t.remove(),t.skip())}},ExportDeclaration:{enter:t=>{switch(t.node.type){case"ExportDefaultDeclaration":if(e.isIdentifier(t.node.declaration)&&s.has(t.node.declaration.name)){let[a,f,c]=s.get(t.node.declaration.name).split("."),{global:d}=r[c],g=`__external__${d}__`,y=e.variableDeclaration("var",[e.variableDeclarator(e.identifier(g),e.identifier(d))]);t.insertBefore(y),t.replaceWith(e.exportDefaultDeclaration(e.identifier(g)))}break;case"ExportNamedDeclaration":(n[t.node.source?.value]||!t.node.declaration)&&m(t);break;case"ExportAllDeclaration":n[t.node.source.value]&&p(t)}}},Declaration:t=>{if(xe(t)){if(e.isClassDeclaration(t.node)||e.isFunctionDeclaration(t.node)){let a=t.node.id?.name;if(!a)return;i.has(a)&&i.get(a).remove(),i.set(a,t)}e.isVariableDeclaration(t.node)&&b(t.get("declarations"),i)}},Identifier:t=>{if(e.isReferenced(t.node,t.parent)&&s.has(t.node.name)&&!t.scope.hasBinding(t.node.name)){let[a,f]=s.get(t.node.name).split(".");f==="ImportNamespaceSpecifier"||f==="ImportDefaultSpecifier"?t.node.name=a:t.node.name=[a,f].join("."),t.skip()}}}}}}async function Ve(o,r){let n=await be(o,{babelrc:!1,configFile:!1,sourceMaps:!0,plugins:[[he(r)]]});return{code:n.code,map:n.map}}async function Y(o){let r=await ge(o,{babelrc:!1,configFile:!1}),{body:n}=r.program;if(!M(n))return;let s=n[0];if(e.isVariableDeclaration(s)){let m=s.declarations[0].id;if(e.isIdentifier(m))return m.name}let i="",u="";return ye(r,{ExpressionStatement:m=>{if(e.isCallExpression(m.node.expression)&&e.isFunctionExpression(m.node.expression.callee)){let p=m.node.expression.callee.params;M(p)&&p[0].type==="Identifier"&&!u&&(u=p[0].name)}},AssignmentExpression:m=>{if(i)return m.skip();let p=m.get("left");if(p.node.type==="MemberExpression"){let{start:b,end:t}=p.node.object;new RegExp(u||"global","i").test(o.slice(b,t))&&e.isIdentifier(p.node.property)&&(i||(i=p.node.property.name))}}}),i}var re=Ee.createRequire(import.meta.url),we=q.fileURLToPath(import.meta.url);function Pe(o,r){let{port1:n,port2:s}=new A.MessageChannel,i=new A.Worker(we,{workerData:{workerPort:s,internalThread:!0,scannerModule:o.modules,defaultWd:r},transferList:[s],execArgv:[]}),u=0;return i.unref(),(()=>{let p=new SharedArrayBuffer(4),b=new Int32Array(p);i.postMessage({sharedBuffer:p,id:u});let t=Atomics.wait(b,0,0);if(t!=="ok"&&t!=="not-equal")throw new Error("Internal error: Atomics.wait() failed: "+t);let{message:a}=A.receiveMessageOnPort(n);if(a.id!==u)throw new Error(`Internal error: Expected id ${u} but got id ${a.id}`);if(a.error)throw a.error;let{bindings:f,failedModules:c}=a;return{dependencies:f,failedModules:c}})()}function ee(o,r=[]){return r.filter(n=>n!==".").map(n=>Me.posix.join(o,n))}async function De(...o){let r;switch(M(o)){case 1:{let i=o[0];if(typeof i!="string")throw new Error("Invalid type");r=await F(q.pathToFileURL(i));break}case 2:{let[i,u]=o;if(typeof i!="object")throw new Error("Invalid type");let m=re.resolve(i.name,{paths:[u]});r=await F(q.pathToFileURL(m));break}}let n=Object.keys(r);if(n.includes("default")&&M(n)!==1){let i=n.findIndex(u=>u==="default");n.splice(i,1),n.push(...Object.keys(r.default))}return new Set(n.filter(i=>i!=="__esModule"))}async function Ne(o,r,n,s){let{name:i,relativeModule:u,aliases:m,...p}=o;try{let b=re.resolve(i,{paths:[s]}),t=_(b,"package.json"),a=await Z.readFile(t,"utf8"),f=JSON.parse(a),{version:c,name:d,unpkg:g,jsdelivr:y}=f,I=Object.create(null),k=u||y||g;if(!k)throw new Error("try resolve file failed.");if(p.global)Object.assign(I,{name:d,version:c,relativeModule:k,aliases:ee(d,m),...p});else{let j=_(t,k),l=await Z.readFile(j,"utf8");Object.assign(I,{name:d,version:c,code:l,relativeModule:k,aliases:ee(d,m),...p})}let v=await De(b);r.set(d,{...I,bindings:v})}catch(b){let t=(()=>b instanceof Error?"code"in b&&b.code==="MODULE_NOT_FOUND"?"can't find module.":b.message:b)();n.set(i,t)}}function Ie(){if(!A.workerData.internalThread)return;let{workerPort:o,scannerModule:r,defaultWd:n}=A.workerData,{parentPort:s}=A,i=new Map,u=new Map;s?.on("message",m=>{(async()=>{let{id:p,sharedBuffer:b}=m,t=new Int32Array(b);try{let a=new Map,f=K(H);for(let c of r)f.enqueue(()=>Ne(c,i,u,n));await f.wait();for(let c of r){let{name:d}=c;if(i.has(d)){let{code:g,...y}=i.get(d);if(!g){a.set(d,y);continue}let I=await Y(g);I?a.set(d,{...y,global:I}):u.set(d,"try resolve global name failed.")}}i.clear(),o.postMessage({bindings:a,id:p,failedModules:u})}catch(a){o.postMessage({error:a,id:p})}Atomics.add(t,0,1),Atomics.notify(t,0,1/0)})()})}A.workerData?.internalThread&&Ie();var C=class{modules;dependencies;failedModules;defaultWd;constructor(r){this.modules=r,this.dependencies=new Map,this.failedModules=new Map,this.defaultWd=process.cwd()}setDefaultWd(r){this.defaultWd=r}scanAllDependencies(){let r=Pe(this.serialization(this.modules),this.defaultWd);this.dependencies=r.dependencies,this.failedModules=r.failedModules}serialization(r){Q(Array.isArray(r),"vite-plugin-cdn2: option module must be array");let n=[],s=new Set;for(let i of r){if(typeof i=="string"){if(s.has(i)||!i)continue;n.push({name:i}),s.add(i);continue}!i.name||s.has(i.name)||(n.push(i),s.add(i.name))}return{modules:n}}};function Ye(o){return new C(o)}export{M as a,Re as b,Q as c,Fe as d,Ve as e,ee as f,De as g,Ye as h};
