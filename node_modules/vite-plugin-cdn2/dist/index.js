var je=Object.create;var _=Object.defineProperty;var Te=Object.getOwnPropertyDescriptor;var Oe=Object.getOwnPropertyNames;var Re=Object.getPrototypeOf,We=Object.prototype.hasOwnProperty;var _e=(r,e)=>()=>(r&&(e=r(r=0)),e);var Z=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports),Le=(r,e)=>{for(var o in e)_(r,o,{get:e[o],enumerable:!0})},ee=(r,e,o,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Oe(e))!We.call(r,s)&&s!==o&&_(r,s,{get:()=>e[s],enumerable:!(i=Te(e,s))||i.enumerable});return r};var E=(r,e,o)=>(o=r!=null?je(Re(r)):{},ee(e||!r||!r.__esModule?_(o,"default",{value:r,enumerable:!0}):o,r)),Fe=r=>ee(_({},"__esModule",{value:!0}),r);var $e,A,x=_e(()=>{$e=()=>require("url").pathToFileURL(__filename).href,A=$e()});var te=Z((sr,T)=>{"use strict";x();var{bind:Ce,call:qe}=Function.prototype,He=Ce.bind(qe);T.exports.uncurryThis=He;var Be=Object.getPrototypeOf(Uint8Array.prototype);T.exports.TypedArrayPrototype=Be;var Ue=(r,e,o,i)=>{if(e in r){if(i===!0){if(r[e]===o)return}else if(!(typeof i=="function"&&Object.prototype.toString.call(i)==="[object Function]")||!i())return}Object.defineProperty(r,e,{configurable:!0,enumerable:!1,value:o,writable:!0})},re=(r,e,o={})=>{let i=Array.prototype.concat.call(Object.keys(e),Object.getOwnPropertySymbols(e));for(let s=0,p=i.length;s<p;s++)Ue(r,i[s],e[i[s]],o[i[s]])};T.exports.defineProperties=re;var Ve=(r,e)=>re(r,{implementation:e,getPolyfill:()=>e,shim:()=>e});T.exports.makeEsShim=Ve});var se=Z((cr,ie)=>{"use strict";x();var{makeEsShim:ze}=te(),ne=typeof AggregateError=="function"?AggregateError:(()=>{function r(e,o){let i=new Error(o);return Object.setPrototypeOf(i,r.prototype),delete i.constructor,Object.defineProperty(i,"errors",{value:Array.from(e)}),i}return Object.defineProperty(r,"prototype",{writable:!1}),Object.defineProperties(r.prototype,{constructor:{enumerable:!1,configurable:!0,writable:!0,value:r},message:{enumerable:!1,configurable:!0,writable:!0,value:""},name:{enumerable:!1,configurable:!0,writable:!0,value:"AggregateError"}}),Object.setPrototypeOf(r.prototype,Error.prototype),r})(),oe=ne;ze(oe,ne);ie.exports=oe});var nr={};Le(nr,{cdn:()=>ke,default:()=>tr,defineLink:()=>Pe,defineScript:()=>De,external:()=>Y});module.exports=Fe(nr);x();var Ie=require("@rollup/pluginutils"),K=E(require("debug"));x();var z=E(require("fs/promises")),$=E(require("url")),ye=E(require("module")),xe=E(require("path")),N=E(require("worker_threads"));x();var t=require("@babel/core");x();var H=E(require("path")),ae=E(require("fs")),ce=E(require("os")),le=E(require("process")),de=E(require("magic-string")),ue=E(se());function L(r,e){let o=H.default.dirname(r),i=H.default.join(o,e);return ae.default.existsSync(i)?i:L(o,e)}function w(r){return r.length}function pe(){let[r,e]=le.default.versions.node.split(".");return+r<12||+r==12&&+e<17||+r==13&&+e<13?[!1,`${r}.${e}`]:[!0,`${r}.${e}`]}function F(r,e){if(!r)throw new Error(e)}var U=new Function("specifier","return import(specifier)");function V(r,e){let o=new de.default(r);for(let i in e){let s=new RegExp(`require\\((["'\`])\\s*${i}\\s*(\\1)\\)`,"g");o.replace(s,e[i].global)}return{code:o.toString(),map:o.generateMap()}}var fe=(()=>{let r=ce.default.cpus()||{length:1};return Math.max(1,r.length-1)})(),B=class{maxConcurrent;queue;running;errors;constructor(e){this.maxConcurrent=e,this.queue=[],this.running=0,this.errors=[]}enqueue(e){this.queue.push(e),this.run()}async run(){for(;this.running<this.maxConcurrent&&this.queue.length;){let e=this.queue.shift();this.running++;try{await e?.()}catch(o){this.errors.push(o)}finally{this.running--,this.run()}}}async wait(){for(;this.running;)await new Promise(e=>setTimeout(e,0));if(w(this.errors))throw new ue.default(this.errors,"failed")}};function me(r){return new B(r)}function Je(r){return t.types.isProgram(r.parent)||t.types.isExportDefaultDeclaration(r.parent)||t.types.isExportNamedDeclaration(r.parent)}function Ge(r){return function(){let{dependency:e,dependencyWithAlias:o}=r,i=new Map,s=new Map,p=n=>{let a=o[n.node.source.value],{global:u}=e[a];for(let c of n.node.specifiers)switch(c.type){case"ImportDefaultSpecifier":case"ImportNamespaceSpecifier":i.set(c.local.name,`${u}.${c.type}.${a}`);break;case"ImportSpecifier":c.imported.type==="Identifier"&&i.set(c.local.name,`${u}.${c.imported.name}.${a}`)}},l=n=>{let a=[],u=[],c=n.node.source,f=c?o[n.node.source.value]:"",y=c&&f?e[f].global:"",b=c&&f?e[f].bindings:new Set,P=(m,h,S)=>{if(b.size){if(m.name==="default"&&m.name!==h.name){let D=I=>t.types.memberExpression(t.types.identifier(y),t.types.identifier(I)),v=[...b.keys()].map(I=>t.types.objectProperty(t.types.identifier(I),D(I))),M=t.types.variableDeclarator(t.types.identifier(h.name),t.types.objectExpression(v));a.push(M);return}if(h.name==="default"&&m.name!==h.name){let D=t.types.memberExpression(t.types.identifier(y),t.types.identifier(m.name));a.push(D);return}if(m.name===h.name){if(m.name==="default"){let D=I=>t.types.memberExpression(t.types.identifier(y),t.types.identifier(I)),v=[...b.keys()].map(I=>t.types.objectProperty(t.types.identifier(I),D(I))),M=t.types.objectExpression(v);a.push(M);return}if(b.has(m.name)){let D=t.types.memberExpression(t.types.identifier(y),t.types.identifier(m.name)),v=t.types.variableDeclarator(t.types.identifier(m.name),D);a.push(v);return}}u.push(S)}},k=(m,h,S)=>{if(i.has(m.name)){let[D,v,M]=i.get(m.name).split("."),I=(()=>{if(v==="ImportNamespaceSpecifier"){let Ne=W=>t.types.memberExpression(t.types.identifier(D),t.types.identifier(W));return t.types.objectExpression([...e[M].bindings.keys()].map(W=>t.types.objectProperty(t.types.identifier(W),Ne(W))))}return t.types.memberExpression(t.types.identifier(D),t.types.identifier(v))})();h.name==="default"?a.push(I):a.push(t.types.variableDeclarator(t.types.identifier(m.name),I));return}u.push(S)};for(let m of n.node.specifiers){if(m.type==="ExportSpecifier"){let{local:h,exported:S}=m;if(S.type!=="Identifier")continue;c?P(h,S,m):k(h,S,m)}if(m.type==="ExportNamespaceSpecifier"){let h=m.exported;if(h.name==="default"){let S=M=>t.types.memberExpression(t.types.identifier(y),t.types.identifier(M)),D=[...b.keys()].map(M=>t.types.objectProperty(t.types.identifier(M),S(M))),v=t.types.objectExpression(D);a.push(v)}else{let S=M=>t.types.memberExpression(t.types.identifier(y),t.types.identifier(M)),D=[...b.keys()].map(M=>t.types.objectProperty(t.types.identifier(M),S(M))),v=t.types.variableDeclarator(t.types.identifier(h.name),t.types.objectExpression(D));a.push(v)}}}let j=a.filter(m=>m.type==="VariableDeclarator"),R=a.filter(m=>m.type!=="VariableDeclarator");if(w(R)){let m=t.types.exportDefaultDeclaration(R[0]);w(j)||w(u)?n.insertAfter(m):n.replaceWith(m)}if(w(j)){let m=t.types.variableDeclaration("var",j);if(w(u)){let h=t.types.exportNamedDeclaration(null,u);n.replaceWith(h),n.insertAfter(t.types.exportNamedDeclaration(m,[]))}else n.replaceWith(t.types.exportNamedDeclaration(m,[]))}},d=n=>{let a=[],u=o[n.node.source.value],{bindings:c}=e[u];if(c.forEach(f=>{let y=t.types.identifier(f),b=t.types.exportSpecifier(y,y);a.push(b)}),w(a)){let f=t.types.exportNamedDeclaration(null,a,t.types.stringLiteral(n.node.source.value));n.replaceWith(f)}},g=(n,a)=>{if(!Array.isArray(n))return;let u=c=>{if(!Array.isArray(c)){if(t.types.isVariableDeclarator(c.node)&&((t.types.isObjectPattern(c.node.id)||t.types.isArrayPattern(c.node.id))&&u(c.get("id")),t.types.isRestElement(c.node.id)&&u(c.get("id.argument")),t.types.isIdentifier(c.node.id))){let f=c.node.id.name;a.has(f)&&a.get(f).remove(),a.set(f,c);return}if(t.types.isObjectPattern(c.node))for(let f of c.get("properties"))u(f);if(t.types.isArrayPattern(c.node))for(let f of c.get("elements"))u(f)}};for(let c of n)u(c)};return{visitor:{ImportDeclaration:{enter:n=>{o[n.node.source.value]&&p(n)},exit:n=>{o[n.node.source.value]&&(n.remove(),n.skip())}},ExportDeclaration:{enter:n=>{switch(n.node.type){case"ExportDefaultDeclaration":if(t.types.isIdentifier(n.node.declaration)&&i.has(n.node.declaration.name)){let[a,u,c]=i.get(n.node.declaration.name).split("."),{global:f}=e[c],y=`__external__${f}__`,b=t.types.variableDeclaration("var",[t.types.variableDeclarator(t.types.identifier(y),t.types.identifier(f))]);n.insertBefore(b),n.replaceWith(t.types.exportDefaultDeclaration(t.types.identifier(y)))}break;case"ExportNamedDeclaration":(o[n.node.source?.value]||!n.node.declaration)&&l(n);break;case"ExportAllDeclaration":o[n.node.source.value]&&d(n)}}},Declaration:n=>{if(Je(n)){if(t.types.isClassDeclaration(n.node)||t.types.isFunctionDeclaration(n.node)){let a=n.node.id?.name;if(!a)return;s.has(a)&&s.get(a).remove(),s.set(a,n)}t.types.isVariableDeclaration(n.node)&&g(n.get("declarations"),s)}},Identifier:n=>{if(t.types.isReferenced(n.node,n.parent)&&i.has(n.node.name)&&!n.scope.hasBinding(n.node.name)){let[a,u]=i.get(n.node.name).split(".");u==="ImportNamespaceSpecifier"||u==="ImportDefaultSpecifier"?n.node.name=a:n.node.name=[a,u].join("."),n.skip()}}}}}}async function O(r,e){let o=await(0,t.transform)(r,{babelrc:!1,configFile:!1,sourceMaps:!0,plugins:[[Ge(e)]]});return{code:o.code,map:o.map}}async function ge(r){let e=await(0,t.parse)(r,{babelrc:!1,configFile:!1}),{body:o}=e.program;if(!w(o))return;let i=o[0];if(t.types.isVariableDeclaration(i)){let l=i.declarations[0].id;if(t.types.isIdentifier(l))return l.name}let s="",p="";return(0,t.traverse)(e,{ExpressionStatement:l=>{if(t.types.isCallExpression(l.node.expression)&&t.types.isFunctionExpression(l.node.expression.callee)){let d=l.node.expression.callee.params;w(d)&&d[0].type==="Identifier"&&!p&&(p=d[0].name)}},AssignmentExpression:l=>{if(s)return l.skip();let d=l.get("left");if(d.node.type==="MemberExpression"){let{start:g,end:n}=d.node.object;new RegExp(p||"global","i").test(r.slice(g,n))&&t.types.isIdentifier(d.node.property)&&(s||(s=d.node.property.name))}}}),s}var be=ye.default.createRequire(A),Xe=$.default.fileURLToPath(A);function Qe(r,e){let{port1:o,port2:i}=new N.default.MessageChannel,s=new N.default.Worker(Xe,{workerData:{workerPort:i,internalThread:!0,scannerModule:r.modules,defaultWd:e},transferList:[i],execArgv:[]}),p=0;return s.unref(),(()=>{let d=new SharedArrayBuffer(4),g=new Int32Array(d);s.postMessage({sharedBuffer:d,id:p});let n=Atomics.wait(g,0,0);if(n!=="ok"&&n!=="not-equal")throw new Error("Internal error: Atomics.wait() failed: "+n);let{message:a}=N.default.receiveMessageOnPort(o);if(a.id!==p)throw new Error(`Internal error: Expected id ${p} but got id ${a.id}`);if(a.error)throw a.error;let{bindings:u,failedModules:c}=a;return{dependencies:u,failedModules:c}})()}function C(r,e=[]){return e.filter(o=>o!==".").map(o=>xe.default.posix.join(r,o))}async function G(...r){let e;switch(w(r)){case 1:{let s=r[0];if(typeof s!="string")throw new Error("Invalid type");e=await U($.default.pathToFileURL(s));break}case 2:{let[s,p]=r;if(typeof s!="object")throw new Error("Invalid type");let l=be.resolve(s.name,{paths:[p]});e=await U($.default.pathToFileURL(l));break}}let o=Object.keys(e);if(o.includes("default")&&w(o)!==1){let s=o.findIndex(p=>p==="default");o.splice(s,1),o.push(...Object.keys(e.default))}return new Set(o.filter(s=>s!=="__esModule"))}async function Ke(r,e,o,i){let{name:s,relativeModule:p,aliases:l,...d}=r;try{let g=be.resolve(s,{paths:[i]}),n=L(g,"package.json"),a=await z.default.readFile(n,"utf8"),u=JSON.parse(a),{version:c,name:f,unpkg:y,jsdelivr:b}=u,P=Object.create(null),k=p||b||y;if(!k)throw new Error("try resolve file failed.");if(d.global)Object.assign(P,{name:f,version:c,relativeModule:k,aliases:C(f,l),...d});else{let R=L(n,k),m=await z.default.readFile(R,"utf8");Object.assign(P,{name:f,version:c,code:m,relativeModule:k,aliases:C(f,l),...d})}let j=await G(g);e.set(f,{...P,bindings:j})}catch(g){let n=(()=>g instanceof Error?"code"in g&&g.code==="MODULE_NOT_FOUND"?"can't find module.":g.message:g)();o.set(s,n)}}function Ye(){if(!N.default.workerData.internalThread)return;let{workerPort:r,scannerModule:e,defaultWd:o}=N.default.workerData,{parentPort:i}=N.default,s=new Map,p=new Map;i?.on("message",l=>{(async()=>{let{id:d,sharedBuffer:g}=l,n=new Int32Array(g);try{let a=new Map,u=me(fe);for(let c of e)u.enqueue(()=>Ke(c,s,p,o));await u.wait();for(let c of e){let{name:f}=c;if(s.has(f)){let{code:y,...b}=s.get(f);if(!y){a.set(f,b);continue}let P=await ge(y);P?a.set(f,{...b,global:P}):p.set(f,"try resolve global name failed.")}}s.clear(),r.postMessage({bindings:a,id:d,failedModules:p})}catch(a){r.postMessage({error:a,id:d})}Atomics.add(n,0,1),Atomics.notify(n,0,1/0)})()})}N.default.workerData?.internalThread&&Ye();var J=class{modules;dependencies;failedModules;defaultWd;constructor(e){this.modules=e,this.dependencies=new Map,this.failedModules=new Map,this.defaultWd=process.cwd()}setDefaultWd(e){this.defaultWd=e}scanAllDependencies(){let e=Qe(this.serialization(this.modules),this.defaultWd);this.dependencies=e.dependencies,this.failedModules=e.failedModules}serialization(e){F(Array.isArray(e),"vite-plugin-cdn2: option module must be array");let o=[],i=new Set;for(let s of e){if(typeof s=="string"){if(i.has(s)||!s)continue;o.push({name:s}),i.add(s);continue}!s.name||i.has(s.name)||(o.push(s),i.add(s.name))}return{modules:o}}};function he(r){return new J(r)}x();var Me=require("url"),Ee=E(require("path"));function Ze(r){let{pathname:e}=new Me.URL(r,"https://www.example.com");return Ee.default.extname(e)===".js"?"script":"link"}function X(r){let{url:e,...o}=r,i={tag:Ze(e),...o};return i.tag==="script"?i.attrs.src=e:(i.attrs.href=e,i.attrs.rel="stylesheet"),i}var Q=class{_tagDescriptors;constructor(e,o){F(!!o||!!o.name,"[vite-plugin-cdn2]: missing resolve."),this._tagDescriptors=this.prepareSource(e,o)}get tagDescriptors(){return this._tagDescriptors}prepareSource(e,o){let i=[],s=(p,l)=>{if(typeof p=="string"&&i.push(X({url:p,injectTo:l,attrs:{}})),Array.isArray(p))for(let d of p){let{url:g,...n}=d;i.push(X({url:g,injectTo:l,attrs:n??{}}))}};for(let[p,l]of e){let d=X(o.setup({extra:l}));l.spare&&s(l.spare,d.injectTo),i.push(d)}return i}};function we(r,e){return new Q(r,e)}x();x();function De(r){return r}function Pe(r){return r}function ve(r={}){let{injectTo:e="head-prepend",attrs:o={}}=r,i="https://cdn.jsdelivr.net/npm/";return{name:"resolve:jsdelivr",setup({extra:s}){let{version:p,name:l,relativeModule:d}=s;return{url:new URL(`${l}@${p}/${d}`,i).href,injectTo:e,attrs:{...o}}}}}var q=(0,K.default)("vite-plugin-cdn2"),Se="node_modules";async function Ae(){try{let{parse:r}=(await import("rs-module-lexer")).default;return r}catch{let{parse:e}=await import("@xn-sakina/rml-wasm").catch(()=>{throw new Error("rs-module-lexer can't work on you current machine.")});return e}}function er(){let r={},e=(o,i,s,p)=>{let{output:l}=p({input:[{filename:i,code:o}]});if(!w(l))return!1;let{imports:d}=l[0],g=Array.from(new Set([...d.map(n=>n.n)]));for(let n of g)if(s[n])return!0;return!1};return{dependency:r,lex:null,get dependencyWithAlias(){let o=(i,s)=>i.reduce((p,l)=>({...p,[l]:s}),{});return Object.values(this.dependency).reduce((i,s)=>(s.aliases&&(i={...i,...o(s.aliases,s.name)}),{...i,[s.name]:s.name}),{})},filter:function(o,i){return e(o,i,this.dependencyWithAlias,this.lex)}}}function rr(r){return{name:"vite-plugin-cdn2:presetModule",transform(e,o){if(r.filter(o)&&o.includes(Se)){let i=V(e,r.dependency.dependency);return r.dependency.filter(e,o)?O(e,r.dependency):i}}}}function ke(r={}){let{modules:e=[],include:o=/\.(mjs|js|ts|vue|jsx|tsx)(\?.*|)$/,exclude:i,logLevel:s="warn",resolve:p=ve(),apply:l="build"}=r,d=he(e),{api:g}=Y({modules:[],include:o,exclude:i}),n=g;return[{...(()=>({name:"vite-plugin-cdn2:transform",enforce:"post",apply:l,async configResolved(u){let[c,f]=pe();try{if(!c)throw new Error(`vite-plugin-cdn2 can't work with nodejs ${f}.`);let y=await Ae();n.dependency.lex=y;let b=u.root;if(d.setDefaultWd(b),q("start scanning"),d.scanAllDependencies(),q("scanning done",d.dependencies),n.dependency.dependency=Object.fromEntries(d.dependencies),s==="warn"&&d.failedModules.forEach((P,k)=>u.logger.error(`vite-plugin-cdn2: ${k} ${P||"resolved failed.Please check it."}`)),l==="serve"){let P=u.optimizeDeps?.exclude||[];u.optimizeDeps.exclude=[...P,...d.dependencies.keys()];let k=u.optimizeDeps?.include||[];u.optimizeDeps.include=k.filter(j=>!u.optimizeDeps.exclude.includes(j))}}catch(y){u.logger.error(y)}},transform(u,c){if(n.filter(c)&&n.dependency.filter(u,c))return O(u,n.dependency)},transformIndexHtml(u){q("start transformIndexHtml");let c=we(d.dependencies,p);return q("transformIndexHtml Done",c.tagDescriptors),{html:u,tags:c.tagDescriptors}}}))(),apply:l},{...rr(n),apply:l}]}function Y(r={}){let e=(0,K.default)("vite-plugin-external"),{modules:o=[],include:i,exclude:s}=r,p=(0,Ie.createFilter)(i,s),l=er();return{name:"vite-plugin-external",async buildStart(){try{let d=await Ae();l.lex=d,e("start check modules");for(let a of o)if(!a.global)throw new Error(`vite-plugin-external: missing global for module ${a.name}`);e("check done");let g=process.cwd(),n=await Promise.all(o.map(async a=>({bindings:await G(a,g),...a,aliases:C(a.name,a.aliases)})));l.dependency=n.reduce((a,u)=>({...a,[u.name]:u}),{}),e("scanning done",l.dependency)}catch(d){this.error(d)}},transform(d,g){if(p(g)){if(g.includes(Se)){let n=V(d,l.dependency);return l.filter(d,g)?O(d,l):n}if(l.filter(d,g))return O(d,l)}},api:{filter:p,dependency:l}}}Y.getExternalPluginAPI=r=>r.find(e=>e.name==="vite-plugin-external")?.api;var tr=ke;0&&(module.exports={cdn,defineLink,defineScript,external});
